openapi: 3.0.3
info:
  title: Calculadora Eléctrica RD - API
  description: |
    API para cálculos eléctricos residenciales, comerciales e industriales.
    
    ## Funcionalidades Principales
    
    ### Cálculos Eléctricos
    - **CE-01**: Motor de Cálculo de Cargas por Ambiente
    - **CE-02**: Factores de Demanda y Carga Diversificada
    - **CE-03**: Agrupación de Circuitos Ramales + Selección de Conductores
    - **CE-04**: Caída de Tensión, Alimentador y Acometida
    - **CE-05**: Puesta a Tierra y Conductores de Protección
    - **CE-06**: Reporte Técnico y Cuadro de Cargas
    
    ### Características Técnicas
    - Cumple con normas NEC 2023 y RIE RD
    - Cálculos automáticos de conductores y protecciones
    - Generación de reportes PDF y Excel
    - Validación automática de cumplimiento normativo
    - Soporte para múltiples tipos de instalación
    
    ### Autenticación
    - JWT RS256 con JWKS
    - API Key para endpoints administrativos
    - Gestión de sesiones y tokens de refresco
    
  version: 1.0.0
  contact:
    name: Calculadora Eléctrica RD
    url: https://calculadoraelectricrd.com
    email: soporte@calculadoraelectricrd.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Servidor de desarrollo
  - url: https://api.calculadoraelectricrd.com
    description: Servidor de producción

security:
  - bearerAuth: []
  - apiKeyAuth: []

paths:
  # CE-01: Motor de Cálculo de Cargas por Ambiente
  /calc/rooms/preview:
    post:
      tags:
        - Cálculos Eléctricos
      summary: Calcular cargas por ambiente
      description: |
        Calcula las cargas eléctricas por ambiente basado en superficies y consumos definidos.
        
        **Funcionalidades:**
        - Cálculo automático de cargas por ambiente
        - Aplicación de factores de carga según tipo de ambiente
        - Validación de parámetros eléctricos
        - Cálculo de corrientes y potencias totales
        
        **Tipos de ambiente soportados:**
        - Dormitorio, Sala, Cocina, Baño, Oficina, etc.
        
        **Parámetros de salida:**
        - Carga total por ambiente (VA)
        - Corriente calculada (A)
        - Factor de potencia aplicado
        - Observaciones y recomendaciones
      operationId: calculateRooms
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/RoomsRequest'
            examples:
              residencial:
                summary: Ejemplo residencial
                description: Cálculo para vivienda con sala, cocina, habitación y baño
                value:
                  system:
                    voltage: 120
                    phases: 1
                    frequency: 60
                  superficies:
                    - nombre: "Sala"
                      area_m2: 18
                    - nombre: "Cocina"
                      area_m2: 12
                    - nombre: "Habitación 1"
                      area_m2: 12
                    - nombre: "Baño"
                      area_m2: 5
                  consumos:
                    - nombre: "Nevera"
                      ambiente: "Cocina"
                      potencia_w: 200
                      tipo: "electrodomestico"
                      fp: 0.95
                    - nombre: "Microondas"
                      ambiente: "Cocina"
                      potencia_w: 1200
                      tipo: "electrodomestico"
                      fp: 0.95
                    - nombre: "TV"
                      ambiente: "Sala"
                      potencia_w: 140
                      tipo: "electrodomestico"
                    - nombre: "A/C 12k BTU"
                      ambiente: "Habitación 1"
                      potencia_w: 1100
                      tipo: "climatizacion"
                      fp: 0.9
                    - nombre: "Lavadora"
                      ambiente: "Baño"
                      potencia_w: 500
                      tipo: "electrodomestico"
                      fp: 0.9
      responses:
        '200':
          description: Cálculo completado exitosamente
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/RoomsResponse'
              examples:
                success:
                  summary: Respuesta exitosa
                  description: Resultado del cálculo de cargas por ambiente
                  value:
                    ambientes:
                      - nombre: "Sala"
                        area_m2: 18
                        carga_va: 840
                        fp: 0.9
                        corriente_a: 7.0
                        observaciones: ["Carga estándar para sala de estar"]
                      - nombre: "Cocina"
                        area_m2: 12
                        carga_va: 1680
                        fp: 0.95
                        corriente_a: 14.0
                        observaciones: ["Incluye electrodomésticos principales"]
                    totales:
                      carga_total_va: 2520
                      carga_diversificada_va: 2520
                      corriente_total_a: 21.0
                      tension_v: 120
                      phases: 1
                    metadata:
                      calculation_date: "2024-01-15T10:30:00Z"
                      norms_version: "NEC 2023 + RIE RD"
                      system_version: "1.0.0"
        '400':
          description: Datos de entrada inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      type: string
                  error:
                    type: string
                  statusCode:
                    type: number
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  error:
                    type: string
                  statusCode:
                    type: number

  # CE-02: Factores de Demanda y Carga Diversificada
  /calc/demand/preview:
    post:
      tags:
        - Cálculos Eléctricos
      summary: Calcular factores de demanda y carga diversificada
      description: |
        Aplica factores de demanda y calcula la carga diversificada según el tipo de instalación.
        
        **Funcionalidades:**
        - Aplicación automática de factores de demanda
        - Cálculo de carga diversificada
        - Validación según tipo de instalación
        - Análisis de ahorro energético
        
        **Tipos de instalación:**
        - Residencial: Factores según NEC 220.42
        - Comercial: Factores según NEC 220.44
        - Industrial: Factores según NEC 220.50
      operationId: calculateDemand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/DemandRequest'
            examples:
              residencial:
                summary: Ejemplo residencial
                description: Cálculo de demanda para vivienda
                value:
                  cargas_por_categoria:
                    - categoria: "iluminacion_general"
                      carga_bruta_va: 1200
                    - categoria: "tomas_generales"
                      carga_bruta_va: 2400
                    - categoria: "electrodomesticos"
                      carga_bruta_va: 3600
                  parametros:
                    tipo_instalacion: "residencial"
      responses:
        '200':
          description: Cálculo de demanda completado
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/DemandResponse'

  # CE-03: Agrupación de Circuitos Ramales + Selección de Conductores
  /calc/circuits/preview:
    post:
      tags:
        - Cálculos Eléctricos
      summary: Agrupar circuitos ramales y seleccionar conductores
      description: |
        Agrupa cargas en circuitos ramales y selecciona conductores apropiados.
        
        **Funcionalidades:**
        - Agrupación automática de cargas
        - Selección de conductores según ampacidad
        - Dimensionamiento de protecciones
        - Validación de límites de circuito
      operationId: calculateCircuits
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/CircuitsRequest'
      responses:
        '200':
          description: Circuitos dimensionados exitosamente
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/CircuitsResponse'

  # CE-04: Caída de Tensión, Alimentador y Acometida
  /calc/feeder/preview:
    post:
      tags:
        - Cálculos Eléctricos
      summary: Calcular caída de tensión en alimentador y acometida
      description: |
        Calcula la caída de tensión en el alimentador principal y valida límites.
        
        **Funcionalidades:**
        - Cálculo de caída de tensión por circuito
        - Cálculo de caída de tensión total
        - Validación de límites normativos
        - Recomendaciones de calibre
      operationId: calculateFeeder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/FeederRequest'
      responses:
        '200':
          description: Análisis de caída de tensión completado
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/FeederResponse'

  # CE-05: Puesta a Tierra y Conductores de Protección
  /calc/grounding/preview:
    post:
      tags:
        - Cálculos Eléctricos
      summary: Dimensionar puesta a tierra y conductores de protección
      description: |
        Dimensiona conductores de protección (EGC) y tierra (GEC) según normas.
        
        **Funcionalidades:**
        - Dimensionamiento EGC según NEC 250.66
        - Dimensionamiento GEC según normas aplicables
        - Configuración de sistema de tierra
        - Validación de cumplimiento normativo
      operationId: calculateGrounding
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/GroundingRequest'
      responses:
        '200':
          description: Dimensionamiento de puesta a tierra completado
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/GroundingResponse'

  # CE-06: Reporte Técnico y Cuadro de Cargas
  /calc/report:
    post:
      tags:
        - Cálculos Eléctricos - Reportes
      summary: Generar reporte técnico completo (PDF y Excel)
      description: |
        Genera un reporte técnico completo en formato PDF y Excel.
        
        **Funcionalidades:**
        - Genera reporte PDF profesional
        - Genera archivo Excel con múltiples hojas
        - Incluye sello de tiempo y versión de normas
        - Calcula hashes MD5 para verificación
      operationId: generateReport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/ReportRequest'
      responses:
        '200':
          description: Reporte generado exitosamente
          content:
            application/json:
              schema:
                $ref: '../schemas/output.schema.json#/definitions/ReportResponse'
          headers:
            x-pdf-hash:
              description: Hash MD5 del archivo PDF
              schema:
                type: string
            x-excel-hash:
              description: Hash MD5 del archivo Excel
              schema:
                type: string
            x-report-date:
              description: Fecha de generación del reporte
              schema:
                type: string
                format: date-time

  /calc/report/download:
    post:
      tags:
        - Cálculos Eléctricos - Reportes
      summary: Descargar reporte como archivos binarios
      description: |
        Descarga el reporte como archivo ZIP con PDF y Excel.
      operationId: downloadReport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/input.schema.json#/definitions/ReportRequest'
      responses:
        '200':
          description: Archivo ZIP descargado
          content:
            application/zip:
              schema:
                type: string
                format: binary
          headers:
            content-disposition:
              description: Nombre del archivo de descarga
              schema:
                type: string

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtenido del endpoint de autenticación
    apiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API Key para endpoints administrativos

  schemas:
    Error:
      type: object
      properties:
        message:
          type: array
          items:
            type: string
          description: Lista de errores de validación
        error:
          type: string
          description: Tipo de error
        statusCode:
          type: number
          description: Código de estado HTTP
      required:
        - message
        - error
        - statusCode

tags:
  - name: Cálculos Eléctricos
    description: Endpoints para cálculos eléctricos principales
  - name: Cálculos Eléctricos - Reportes
    description: Generación de reportes técnicos en PDF y Excel
  - name: Autenticación
    description: Gestión de usuarios y autenticación
  - name: Administración
    description: Endpoints administrativos y de configuración
